<html>
<head>
<title>SVG test</title>
  <!--
  <script type="text/javascript" src="rome.js"></script>
  -->
  <script type="text/javascript" src="several_countries.js"></script>
  <link type="text/css" href="jquery/jquery-ui-1.8.14.custom.css" rel="stylesheet" />
  <!--
  <script type='text/javascript' src='https://www.google.com/jsapi?key=ABQIAAAAafDALeUVyxhUndZQcT0BRRQjgiEk1Ut90lZbiCSD8tXKcVgrkBQLYOFQ3xwutc5R9SNzfGaKxMnf7g'></script>
  -->
  <script src="jquery/jquery-1.7.1.min.js" type="text/javascript"></script>
  <script src="jquery/jquery-ui-1.8.14.custom.min.js" type="text/javascript"></script>

  <script type="text/javascript">
    function setLegend() {
      var htmls = $('path')
        .filter(function(a,x) { return x.getAttribute("d") != "M 11445 4535 z" })
        .map(function(a,x) {
          return "<span class=legend-entry style='color: " +
              x.getAttribute("fill") + "'>" +
              x.id + "</span><br/>"
        });
      $('#legend').html($.makeArray(htmls).join("\n"));
    }

    $(function(){
      var last_drawn_idx = -1;

      // create paths for all empires/nations
      for (var k in colors) {
        var el = document.createElementNS("http://www.w3.org/2000/svg", "path");
        el.id = k;
        el.setAttribute('stroke-width', 10);
        el.setAttribute('fill', colors[k]);
        el.setAttribute('stroke-linejoin', 'round');
        el.setAttribute('d', 'M 11445 4535 z');
        // TODO(danvk): use jquery SVG to do this?
        el.onmouseover = function(e) {
          $('#highlighted-country').html(e.target.id);
          e.target.setAttribute('stroke-width', 20);
        };
        el.onmouseout = function(e) {
          $('#highlighted-country').html('');
          e.target.setAttribute('stroke-width', 10);
        };
        document.getElementById('ctry').appendChild(el);
      }

      $('#slider').slider({
        range: false,
        value: -100,
        min: -400,
        max: 1600,
        slide: function(event, ui) {
          var year = ui.value;
          var this_year_idx = 0;
          for (var i = 0; i < rome.length; i++) {
            if (rome[i][0] > year) {
              this_year_idx = i - 1;
              break;
            }
          }

          var cum_delta = {};
          var sgn = this_year_idx - last_drawn_idx < 0 ? -1 : +1;
          for (var i = last_drawn_idx + sgn; ; i += sgn) {
            var data = rome[i][1];
            for (var k in data) {
              cum_delta[k] = data[k];
            }
            if (i == this_year_idx) break;
          }

          for (var k in cum_delta) {
            var d = cum_delta[k];
            if (d == '') d = 'M 11445 4535 z';
            $('#' + k).attr("d", d);
          }

          var str = year > 0 ? 'A.D.' : 'B.C.';
          $('#year').text('' + Math.abs(year) + ' ' + str);
          setLegend();
        },
        // change: function(event, ui) {
        //   // ...
        // }
      });

      $('#legend').on({
        'mouseenter': function(e) {
          $('#' + e.target.textContent).attr('stroke-width', '20');
        },
        'mouseleave': function(e) {
          $('#' + e.target.textContent).attr('stroke-width', '10');
        }
      }, '.legend-entry');
    });
  </script>
</head>
<body>

<div id="slider" style="position: absolute; left: 20px; top: 10px; width:800px; height: 14px;"></div>

<div id="year" style="position: absolute; top: 10px; left: 920px; width: 100px; height: 40px;">100 B.C.</div>
<div id="highlighted-country" style="position: absolute; top: 50px; left:920px; width:200px; font-weight: bold;"></div>

<div id="legend" style="position: absolute; top: 100px; left:20px; width:200px; font-weight: bold;"></div>

<div style="position: absolute; top: 100px; left:50%; width: 800px; margin-left: -400px; border: 1px solid black;">
<svg width=800 height=600 viewBox='11100 2750 4000 3000'>
  <g id="ctry" stroke="#999999" stroke-width="1" stroke-miterlimit="1" stroke-linejoin="round" stroke-linecap="round">

  </g>
</svg>
</div>

<div style="position: absolute; top: 100px; left:50%; width: 800px; height: 600px; margin-left: -400px; border: 1px solid black; pointer-events: none;">
<img src="rome-bg-800x600.png" width=800 height=600 />
</div>

</body>
</html>
